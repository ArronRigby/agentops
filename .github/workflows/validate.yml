name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON
        run: |
          echo "=== Validating JSON ==="
          python3 -m json.tool .claude-plugin/marketplace.json > /dev/null
          echo "✅ marketplace.json"

          for f in plugins/*/.claude-plugin/plugin.json; do
            python3 -m json.tool "$f" > /dev/null
            echo "✅ $f"
          done

      - name: Validate structure
        run: |
          echo "=== Validating structure ==="

          # Check marketplace plugins exist
          python3 << 'EOF'
          import json
          import os
          import sys

          with open('.claude-plugin/marketplace.json') as f:
              mp = json.load(f)

          errors = []
          for p in mp.get('plugins', []):
              name = p['name']
              source = p['source'].lstrip('./')
              if source == '':
                  source = '.'

              if not os.path.isdir(source):
                  errors.append(f"{name}: directory {source} not found")
                  continue

              # Check plugin.json exists
              if source == '.':
                  pj = '.claude-plugin/plugin.json'
              else:
                  pj = f'{source}/.claude-plugin/plugin.json'

              if not os.path.isfile(pj):
                  errors.append(f"{name}: missing {pj}")
                  continue

              # Check has skills
              skills_dir = f'{source}/skills' if source != '.' else 'skills'
              if os.path.isdir(skills_dir):
                  skills = [d for d in os.listdir(skills_dir) if os.path.isdir(f'{skills_dir}/{d}')]
                  print(f"✅ {name}: {len(skills)} skills")
              else:
                  print(f"✅ {name}: no skills dir (ok for some plugins)")

          if errors:
              print("\n❌ Errors:")
              for e in errors:
                  print(f"  {e}")
              sys.exit(1)
          EOF

      - name: Check for secrets
        run: |
          echo "=== Scanning for secrets ==="
          if grep -r -i -E "(password|api_key|secret|token).*=.*['\"][^'\"]+['\"]" \
              --exclude-dir=.git \
              --exclude=*.md \
              --exclude=validate.yml \
              . 2>/dev/null; then
            echo "⚠️ Potential secrets found - review above"
            exit 1
          fi
          echo "✅ No secrets detected"
